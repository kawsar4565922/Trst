<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Secret Messaging App</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#FF0055">
<link rel="apple-touch-icon" href="https://i.postimg.cc/B64K9zC9/20251122-030333.png">
<link rel="icon" type="image/png" href="https://i.postimg.cc/B64K9zC9/20251122-030333.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* CSS Styles */
:root{--wa-header-bg:#FF0055;--wa-accent-blue:#34B7F1;--wa-message-out-bg:#FFF4DF;--wa-message-in-bg:#A5F1F6;--wa-app-bg:#AA00FF;--wa-chat-bg:#0000ff;--wa-icon-color:#f0f2f5;--wa-text-primary:#111b21;--wa-text-secondary:#667781;--wa-border-color:#EFD1D4;--wa-active-tab-indicator:var(--wa-accent-blue);--wa-button-color:#00FF55;--wa-link-color:#00a8e8;--wa-shadow:rgba(17,27,33,0.15);--call-end-red:#e91e63;--modal-bg:#FBE8ED;--modal-border-radius:20px;--modal-shadow:12px 12px 24px #bebebe, -12px -12px 24px #ffffff;}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Roboto',sans-serif;}

/* --- UPDATED PART START: Fixed Scrolling Issue --- */
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden; /* Stops global scrolling */
    background-color: #d1d7db;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--wa-text-primary);
    
    /* These properties stop the elastic bounce effect */
    overscroll-behavior: none;
    position: fixed; 
    top: 0;
    left: 0;
}
/* --- UPDATED PART END --- */

.hidden{display:none!important;}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:#f1f1ff;}
::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:6px;}
::-webkit-scrollbar-thumb:hover{background:#a8a8a8;}
#app-container{width:100%;height:100%;max-width:450px;max-height:950px;background-color:var(--wa-app-bg);border-radius:8px;box-shadow:0 4px 12px var(--wa-shadow);display:flex;flex-direction:column;overflow:hidden;position:relative;}
.view{width:100%;height:100%;display:flex;flex-direction:column;background-color:var(--wa-app-bg);position:absolute;top:0;left:0;transition:transform 0.3s ease,opacity 0.3s ease;}
.view.hidden{transform:translateX(100%);opacity:0;pointer-events:none;}
#auth-view.hidden{transform:scale(0.9);opacity:0;}
.view:not(.hidden){transform:translateX(0);opacity:1;}
.icon-btn{background:none;border:none;cursor:pointer;padding:8px;border-radius:50%;display:flex;align-items:center;justify-content:center;position:relative;}
.icon-btn svg{width:24px;height:24px;fill:var(--wa-icon-color);}
.icon-btn:hover{background-color:rgba(255,255,255,0.1);}
#auth-view{justify-content:center;align-items:center;padding:20px;gap:20px;background:#f0f2f5;z-index:50;}
.auth-form-container{width:100%;max-width:380px;background:#f0f2f5;padding:30px;border-radius:20px;box-shadow:12px 12px 24px #bebebe,-12px -12px 24px #ffffff;}
#auth-view h1{color:#444;font-size:2rem;font-weight:700;text-align:center;margin-bottom:8px;}
.auth-developer-subtitle{color:#555;font-size:1rem;font-weight:400;text-align:center;margin-bottom:20px;letter-spacing:0.5px;}
.auth-form{display:flex;flex-direction:column;width:100%;gap:20px;}
.auth-form input{border:none;outline:none;background:#f0f2f5;padding:15px 20px;border-radius:10px;font-size:1rem;color:#555;box-shadow:inset 6px 6px 12px #bebebe,inset -6px -6px 12px #ffffff;}
.auth-form input:focus{box-shadow:inset 4px 4px 8px #bebebe,inset -4px -4px 8px #ffffff;}
.auth-btn{padding:15px;background:#f0f2f5;color:#555;border:none;outline:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:6px 6px 12px #bebebe,-6px -6px 12px #ffffff;transition:all 0.2s ease-in-out;}
.auth-btn:hover{box-shadow:8px 8px 16px #bebebe,-8px -8px 16px #ffffff;}
.auth-btn:active{box-shadow:inset 6px 6px 12px #bebebe,inset -6px -6px 12px #ffffff;color:#333;}
.auth-link{color:#555;text-decoration:none;font-size:0.9rem;text-align:center;cursor:pointer;margin-top:10px;}
.auth-link:hover{text-decoration:underline;}
.error-message{color:var(--call-end-red);font-size:0.9rem;text-align:center;min-height:1.2em;display:none;}
#main-view{z-index:10;}
.main-header{background-color:var(--wa-header-bg);color:var(--wa-icon-color);flex-shrink:0;}
.header-top{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;}
.header-top h1{font-size:1.4rem;font-weight:500;}
.header-top-icons{display:flex;gap:8px;}
.header-nav{display:flex;justify-content:space-around;background-color:var(--wa-header-bg);}
.nav-tab{flex:1;text-align:center;padding:14px 0;font-size:1rem;font-weight:500;color:rgba(240,242,245,0.7);cursor:pointer;position:relative;border-bottom:3px solid transparent;transition:color 0.2s,border-bottom-color 0.2s;}
.nav-tab.active{color:var(--wa-accent-blue);border-bottom-color:var(--wa-active-tab-indicator);}
.badge{position:absolute;top:10px;right:20%;background-color:var(--wa-accent-blue);color:white;font-size:0.75rem;font-weight:500;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;line-height:1;padding-top:1px;}

/* Updated: Added overscroll-behavior to prevent main list bounce */
#main-content{flex:1;overflow-y:auto;position:relative;overscroll-behavior-y: contain;}

.content-panel{width:100%;height:100%;position:absolute;background:#fff;}
.content-panel:not(.active){display:none;}
#home-content.active{display:flex;flex-direction:column;}
.list-item{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--wa-border-color);cursor:pointer;position:relative;overflow:hidden;background-color:#fff;transition:background-color 0.2s;}
.list-item:hover{background-color:var(--wa-app-bg);}
.item-emoji{font-size:2.5rem;margin-right:12px;background:var(--wa-border-color);width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;line-height:1;overflow:hidden;}
.item-emoji img{width:100%;height:100%;object-fit:cover;}
.item-emoji span{font-size:2.5rem;line-height:1;user-select:none;color:var(--wa-text-secondary);}
.item-details{flex:1;overflow:hidden;}
.item-name{font-size:1.1rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.item-subtext{font-size:0.9rem;color:var(--wa-text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.item-actions{display:flex;flex-direction:column;align-items:flex-end;gap:4px;font-size:0.8rem;color:var(--wa-text-secondary);}
.item-actions .badge{position:static;}
#chat-view{background-color:var(--wa-chat-bg);z-index:60;}
.chat-header{display:flex;align-items:center;gap:8px;background-color:var(--wa-header-bg);color:var(--wa-icon-color);padding:10px;flex-shrink:0;}
.chat-contact-info{display:flex;align-items:center;gap:10px;flex:1;cursor:pointer;}
.chat-contact-info .item-emoji{width:40px;height:40px;font-size:1.8rem;margin-right:0;}
.chat-contact-details .item-name{color:var(--wa-icon-color);font-size:1.1rem;}
.chat-contact-details .item-subtext{color:rgba(240,242,245,0.8);font-size:0.8rem;}

/* --- UPDATED PART START: Fixed Chat Messages Scrolling --- */
#chat-messages{
    flex:1;
    overflow-y:auto;
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:8px;
    background-image:url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23bdbdbd' fill-opacity='0.15' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
    /* Prevents scroll chaining to body */
    overscroll-behavior-y: contain; 
    -webkit-overflow-scrolling: touch;
}
/* --- UPDATED PART END --- */

.message-bubble{padding:8px 12px;border-radius:12px;max-width:75%;word-wrap:break-word;box-shadow:0 1px 1px var(--wa-shadow);position:relative;user-select:none;-webkit-user-select:none;}
.message-sent{align-self:flex-end;background-color:var(--wa-message-out-bg);border-top-right-radius:4px;}
.message-received{align-self:flex-start;background-color:var(--wa-message-in-bg);border-top-left-radius:4px;}
.message-content-wrapper{display:flex;align-items:flex-end;}
.message-text{margin-right:4px;white-space:pre-wrap;word-break:break-word;display:inline-block;}
.message-time-status{display:flex;align-items:center;font-size:0.75rem;color:var(--wa-text-secondary);user-select:none;line-height:1;margin-left:8px;flex-shrink:0;}
.message-status-icon{width:14px;height:14px;margin-left:4px;fill:var(--wa-text-secondary);}
.message-status-icon.seen{fill:var(--wa-accent-blue);}
/* Sending Animation */
.message-status-icon.sending {fill: #888; animation: spin 1s linear infinite; transform-origin: center;}
@keyframes spin { 100% { transform: rotate(360deg); } }

#chat-input-container{display:flex;align-items:center;gap:8px;padding:8px 12px;background-color:var(--wa-app-bg);flex-shrink:0;}
#chat-input{flex:1;padding:12px 18px;border:none;border-radius:24px;font-size:1rem;height:48px;resize:none;overflow-y:auto;font-family:'Roboto',sans-serif;}
#chat-input:focus{outline:none;}
#chat-send-btn, #voice-record-btn{background-color:var(--wa-button-color);border-radius:50%;padding:12px;transition:background-color 0.2s;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;}
#chat-send-btn:hover, #voice-record-btn:hover{background-color:#006652;}
#chat-send-btn svg, #voice-record-btn svg{fill:white;width:20px;height:20px;}
#chat-send-btn:disabled, #voice-record-btn:disabled {background-color: #ccc; cursor: not-allowed;}
#recording-ui{display:flex;align-items:center;background:#fff;padding:5px 15px;border-radius:20px;margin-right:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);flex:1;}
.recording-dot{width:10px;height:10px;background-color:red;border-radius:50%;margin-left:8px;animation:blink 1s infinite;}
@keyframes blink{0%{opacity:1;}50%{opacity:0;}100%{opacity:1;}}
.audio-player{width:200px;height:40px;}
#chat-input-container.recording #chat-input{display:none;}
#chat-input-container.recording #voice-record-btn{background-color:#ffdddd;}
#chat-input-container.recording #voice-record-btn svg{fill:red;}
#audio-preview-container {display:flex;align-items:center;background:#fff;padding:5px 10px;border-radius:24px;flex:1;gap:10px;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
#audio-preview-container.hidden {display:none;}
#preview-audio-player {flex:1;height:35px;width:100%;}
#delete-recording-btn {background:none;border:none;cursor:pointer;padding:8px;color:var(--call-end-red);display:flex;align-items:center;justify-content:center;}
#delete-recording-btn svg {fill:var(--call-end-red);width:20px;height:20px;}
/* MEDIA STYLES - PERMANENT VIEW */
.media-bubble {display:flex;align-items:center;gap:10px;padding:8px;background:rgba(0,0,0,0.05);border-radius:10px;cursor:pointer;min-width: 150px;}
.media-text {font-weight:500;color:var(--wa-text-primary);}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;max-width:450px;max-height:950px;margin:auto;}
.modal-content{background:var(--modal-bg);padding:30px;border-radius:var(--modal-border-radius);width:90%;max-width:380px;box-shadow:var(--modal-shadow);display:flex;flex-direction:column;gap:20px;transform:scale(1);transition:transform 0.3s ease-out;color:#555;border:none;}
.modal.hidden .modal-content{transform:scale(0.95);opacity:0;}
.modal-content h2{font-size:1.6rem;color:#444;text-align:center;font-weight:700;margin-bottom:10px;}
.modal-content form{display:flex;flex-direction:column;gap:20px;}
.modal-content input{padding:15px 20px;border:none;outline:none;background:#f0f2f5;border-radius:10px;font-size:1rem;color:#555;box-shadow:inset 6px 6px 12px #bebebe,inset -6px -6px 12px #ffffff;}
.modal-content input:focus{box-shadow:inset 4px 4px 8px #bebebe,inset -4px -4px 8px #ffffff;}
.modal-content button{padding:15px;background:#f0f2f5;color:#555;border:none;outline:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:6px 6px 12px #bebebe,-6px -6px 12px #ffffff;transition:all 0.2s ease-in-out;}
.modal-content button:hover{box-shadow:8px 8px 16px #bebebe,-8px -8px 16px #ffffff;}
.modal-content button:active{box-shadow:inset 6px 6px 12px #bebebe,inset -6px -6px 12px #ffffff;color:#333;}
.modal-content button[type="submit"], #profile-save-name-btn{color:var(--wa-button-color);}
.modal-content .close-modal-btn{color:#555;}
#logout-btn, #partner-modal-delete-chat-btn, #partner-modal-block-btn{color:var(--call-end-red);}
.modal-content p{font-size:1rem;color:#666;text-align:center;}
#profile-view-content{gap:25px;}
.profile-info-frame, .profile-id-frame, .profile-blocked-frame{display:flex;flex-direction:column;align-items:center;gap:15px;padding:20px;background:#f0f2f5;border-radius:15px;box-shadow:8px 8px 16px #bebebe, -8px -8px 16px #ffffff;width:100%;}
.profile-id-frame{align-items:stretch;}
#profile-pic-wrapper{font-size:4.5rem;width:110px;height:110px;margin:0;cursor:pointer;color:var(--wa-text-primary);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:6px 6px 12px #bebebe, -6px -6px 12px #ffffff;}
#profile-pic-wrapper:active{box-shadow:inset 4px 4px 8px #bebebe, inset -4px -4px 8px #ffffff;}
#profile-pic-wrapper span{font-size:4.5rem;}
.profile-name-wrapper{display:flex;align-items:center;gap:10px;}
#profile-view-name{font-size:1.8rem;font-weight:700;word-break:break-all;display:flex;align-items:center;color:#444;}
#profile-edit-name-btn{background:#f0f2f5;padding:8px;border-radius:50%;border:none;cursor:pointer;display:flex;box-shadow:5px 5px 10px #bebebe, -5px -5px 10px #ffffff;color:#555;}
#profile-edit-name-btn:active{box-shadow:inset 3px 3px 6px #bebebe, inset -3px -3px 6px #ffffff;}
#profile-edit-name-btn svg{fill:#555;width:16px;height:16px;}
#profile-edit-name-form{display:flex;gap:8px;margin-top:5px;width:100%;}
#profile-name-input{flex:1;padding:10px;border:none;border-radius:8px;font-size:1rem;}
#profile-save-name-btn{padding:8px 15px;font-size:0.9rem;}
#profile-view-email{font-size:1rem;color:#777;}
.id-wrapper,.email-wrapper{display:flex;align-items:center;justify-content:space-between;width:100%;padding:5px 0;}
.id-text-wrapper,.email-text-wrapper{display:flex;flex-direction:column;gap:2px;overflow:hidden;}
.id-text-wrapper p,.email-text-wrapper p{font-size:0.8rem;color:#777;text-align:left;}
#profile-user-id-text,#profile-user-email-text{font-size:0.95rem;font-weight:500;color:#444;word-break:break-all;}
#profile-copy-id-btn, #profile-copy-email-btn, #partner-modal-copy-id-btn{background:#f0f2f5;border-radius:50%;padding:10px;cursor:pointer;flex-shrink:0;margin-left:12px;border:none;transition:all 0.2s ease;box-shadow:5px 5px 10px #bebebe, -5px -5px 10px #ffffff;}
#profile-copy-id-btn:active, #profile-copy-email-btn:active, #partner-modal-copy-id-btn:active{box-shadow:inset 3px 3px 6px #bebebe, inset -3px -3px 6px #ffffff;}
#profile-copy-id-btn svg, #profile-copy-email-btn svg, #partner-modal-copy-id-btn svg{fill:#555;width:20px;height:20px;display:block;}
.profile-blocked-frame strong{text-align:center;font-size:1.1rem;color:#444;margin-bottom:10px;display:block;}
#blocked-users-list{max-height:150px;overflow-y:auto;background:#f0f2f5;border-radius:10px;border:none;width:100%;box-shadow:inset 4px 4px 8px #bebebe, -4px -4px 8px #ffffff;padding:5px;}
.blocked-user-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #e0e0e0;}
.unblock-btn{font-size:0.8rem;padding:6px 12px;background:#f0f2f5;border-radius:8px;color:var(--wa-link-color);border:none;cursor:pointer;box-shadow:3px 3px 6px #bebebe, -3px -3px 6px #ffffff;}
.unblock-btn:active{box-shadow:inset 2px 2px 4px #bebebe, inset -2px -2px 4px #ffffff;}
.profile-button-group{display:flex;flex-direction:column;gap:15px;margin-top:10px;width:100%;}
.name-with-badge{display:flex;align-items:center;overflow:hidden;}
.item-name-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
#custom-confirm-modal .neumorphism-modal-content, #custom-alert-modal .neumorphism-modal-content, #verified-info-modal .neumorphism-modal-content, #message-options-modal .neumorphism-modal-content{background:#f0f2f5;border-radius:20px;padding:30px 25px;box-shadow:12px 12px 24px #bebebe, -12px -12px 24px #ffffff;width:90%;max-width:360px;display:flex;flex-direction:column;gap:25px;transform:scale(1);transition:transform 0.3s ease-out, opacity 0.3s ease-out;}
#custom-confirm-modal.hidden .neumorphism-modal-content, #custom-alert-modal.hidden .neumorphism-modal-content, #verified-info-modal.hidden .neumorphism-modal-content, #message-options-modal.hidden .neumorphism-modal-content{transform:scale(0.95);opacity:0;}
#custom-confirm-message, #custom-alert-message{font-size:1.1rem;text-align:center;color:#555;line-height:1.5;font-weight:500;word-wrap:break-word;}
#custom-alert-message{color:var(--call-end-red);}
.neumorphism-button-group{display:flex;justify-content:space-between;gap:20px;}
.neumorphism-button-group.vertical{flex-direction:column;gap:15px;}
.neumorphism-button-group button{flex:1;padding:15px;background:#f0f2f5;border:none;outline:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:6px 6px 12px #bebebe, -6px -6px 12px #ffffff;transition:all 0.2s ease-in-out;}
.neumorphism-button-group button:hover{box-shadow:8px 8px 16px #bebebe, -8px -8px 16px #ffffff;}
.neumorphism-button-group button:active{box-shadow:inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;}
#custom-confirm-btn-yes{color:var(--call-end-red);}
#custom-confirm-btn-no{color:#555;}
#custom-alert-btn-ok, #verified-info-btn-ok{color:#555;}
#msg-opt-delete-everyone{color:var(--call-end-red);}
#msg-opt-delete-me{color:#555;}
#msg-opt-copy{color:var(--wa-button-color);}
#msg-opt-cancel{color:#888;}
.verified-badge{display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;width:0.85em;height:0.85em;background-color:var(--wa-accent-blue);border-radius:50%;margin-left:5px;box-sizing:border-box;cursor:pointer;z-index:20;}
.verified-badge svg{width:70%;height:70%;fill:white;stroke:none;}
#profile-view-name .verified-badge{width:0.8em;height:0.8em;}
#notification-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:10000;display:flex;flex-direction:column;align-items:center;pointer-events:none;max-width:90%;}
.custom-notification{background-color:rgba(17, 27, 33, 0.9);color:white;padding:12px 20px;border-radius:20px;margin-top:10px;font-size:0.95rem;box-shadow:0 4px 10px rgba(0, 0, 0, 0.2);opacity:0;transition:opacity 0.3s ease-in-out, transform 0.3s ease-in-out;transform:translateY(100%);text-align:center;pointer-events:all;display:flex;align-items:center;gap:10px;}
.custom-notification.show{opacity:1;transform:translateY(0);}
.notification-action-buttons{display:flex;gap:8px;margin-left:10px;}
.notification-action-buttons button{background:none;border:1px solid white;color:white;padding:4px 10px;border-radius:12px;font-size:0.85rem;cursor:pointer;pointer-events:all;}
.notification-action-buttons button:hover{background-color:rgba(255, 255, 255, 0.2);}
#custom-prompt-modal{background:rgba(0, 0, 0, 0.6);}
#custom-prompt-modal .modal-content{background:#f0f2f5;}
#notification-btn{position:relative;}
#notification-badge{position:absolute;top:6px;right:6px;width:18px;height:18px;font-size:0.7rem;line-height:18px;padding:0;padding-top:1px;}
#notification-view{background-color:#f0f2f5;flex-direction:column;justify-content:flex-start;z-index:70;}
.neumorphism-header{display:flex;align-items:center;padding:12px 16px;background-color:#f0f2f5;flex-shrink:0;box-shadow:6px 6px 12px #bebebe, -6px -6px 12px #ffffff;position:relative;color:#555;}
.neumorphism-header h2{flex:1;text-align:center;font-weight:700;font-size:1.25rem;margin-left:-44px;}
.neumorphism-icon-btn{background:#f0f2f5;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:6px 6px 12px #bebebe, -6px -6px 12px #ffffff;transition:all 0.2s ease-in-out;z-index:10;}
.neumorphism-icon-btn:active{box-shadow:inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;}
.neumorphism-icon-btn svg{width:24px;height:24px;fill:#555;}
#notification-list-content{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:20px;overscroll-behavior-y: contain;}
.notification-item{background:#f0f2f5;border-radius:15px;padding:18px 22px;box-shadow:8px 8px 16px #bebebe, -8px -8px 16px #ffffff;color:#555;display:flex;flex-direction:column;gap:8px;position:relative;padding-right:50px;}
.notification-item-text{font-size:1rem;line-height:1.4;word-wrap:break-word;}
.notification-item-time{font-size:0.8rem;color:#888;text-align:right;}
#no-notifications-msg{text-align:center;color:var(--wa-text-secondary);margin-top:40px;font-size:1rem;}
.notif-delete-btn{position:absolute;top:50%;right:15px;transform:translateY(-50%);width:32px;height:32px;background:#f0f2f5;border:none;border-radius:50%;font-size:1.4rem;color:#999;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:4px 4px 8px #bebebe, -4px -4px 8px #ffffff;transition:all 0.2s ease-in-out;line-height:1;}
.notif-delete-btn:hover{color:var(--call-end-red);}
.notif-delete-btn:active{box-shadow:inset 4px 4px 8px #bebebe, inset -4px -4px 8px #ffffff;}
#support-fab-btn{position:absolute;bottom:25px;right:25px;width:60px;height:60px;background:#f0f2f5;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:8px 8px 16px #bebebe, -8px -8px 16px #ffffff;z-index:100;transition:transform 0.2s ease;}
#support-fab-btn:active{box-shadow:inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;transform:scale(0.95);}
#support-fab-btn svg{width:30px;height:30px;fill:#555;}
#support-view{background-color:#f0f2f5;flex-direction:column;z-index:80;}
#support-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:15px;overscroll-behavior-y: contain;}
.support-bubble{padding:12px 18px;border-radius:15px;max-width:80%;word-wrap:break-word;color:#555;font-size:0.95rem;box-shadow:6px 6px 12px #bebebe, -6px -6px 12px #ffffff;}
.support-bubble.sent{align-self:flex-end;background:#f0f2f5;border-bottom-right-radius:2px;}
.support-bubble.received{align-self:flex-start;background:#e6e6e6;border-bottom-left-radius:2px;}
#support-input-container{padding:15px 20px;display:flex;align-items:center;gap:15px;background:#f0f2f5;box-shadow:0 -4px 12px rgba(0,0,0,0.05);}
#support-input{flex:1;padding:15px;border:none;outline:none;background:#f0f2f5;border-radius:25px;color:#555;box-shadow:inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;}
#support-send-btn{width:50px;height:50px;border:none;border-radius:50%;background:#f0f2f5;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:6px 6px 12px #bebebe, -6px -6px 12px #ffffff;transition:all 0.2s;}
#support-send-btn:active{box-shadow:inset 4px 4px 8px #bebebe, inset -4px -4px 8px #ffffff;}
#support-send-btn svg{width:24px;height:24px;fill:#555;margin-left:4px;}
#calculator-lock-view{width:100%;height:100%;max-width:450px;max-height:950px;background-color:#f0f2f5;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;padding:20px;z-index:50;position:absolute;top:0;left:0;}
#calculator-screen{width:100%;height:120px;background:#f0f2f5;border-radius:15px;margin-bottom:20px;box-shadow:inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;font-size:3rem;text-align:right;padding:20px;color:#444;overflow-x:auto;white-space:nowrap;line-height:80px;}
.calculator-buttons{width:100%;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.calc-btn{width:100%;height:75px;border-radius:20px;background-color:#f0f2f5;box-shadow:6px 6px 12px #bebebe,-6px -6px 12px #ffffff;border:none;font-size:1.8rem;font-weight:500;color:#555;cursor:pointer;transition:all 0.2s ease-in-out;}
.calc-btn:active{box-shadow:inset 4px 4px 8px #bebebe,inset -4px -4px 8px #ffffff;}
.calc-btn.operator{color:var(--wa-header-bg);font-weight:700;}
.calc-btn.equals{background-color:var(--wa-button-color);color:white;font-size:2rem;box-shadow:6px 6px 12px #88ff88,-6px -6px 12px #ffffff;}
.calc-btn.equals:active{box-shadow:inset 4px 4px 8px #008800,inset -4px -4px 8px #33ff33;}
#pin-setup-modal .modal-content{background:#f0f2f5;box-shadow:12px 12px 24px #bebebe,-12px -12px 24px #ffffff;}
#pin-input-field{width:100%;padding:15px;margin:20px 0 10px;border:none;border-radius:10px;box-shadow:inset 6px 6px 12px #bebebe,inset -6px -6px 12px #ffffff;font-size:1.5rem;text-align:center;letter-spacing:5px;}
#set-pin-button{width:100%;padding:15px;background:var(--wa-button-color);color:white;border:none;outline:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:6px 6px 12px #88ff88,-6px -6px 12px #ffffff;transition:all 0.2s ease-in-out;}
#set-pin-button:hover{box-shadow:8px 8px 16px #88ff88,-8px -8px 16px #ffffff;}
#set-pin-button:active{box-shadow:inset 6px 6px 12px #008800,inset -6px -6px 12px #33ff33;}
#pin-setup-error{color:var(--call-end-red);font-size:0.9rem;text-align:center;min-height:1.2em;}
</style>
</head>
<body>
<div id="app-container">
<div id="calculator-lock-view" class="view">
<div id="calculator-screen">0</div>
<div class="calculator-buttons">
<button class="calc-btn operator" data-value="C">AC</button>
<button class="calc-btn operator" data-value="D">DEL</button>
<button class="calc-btn operator" data-value="%">%</button>
<button class="calc-btn operator" data-value="/">√∑</button>
<button class="calc-btn" data-value="7">7</button>
<button class="calc-btn" data-value="8">8</button>
<button class="calc-btn" data-value="9">9</button>
<button class="calc-btn operator" data-value="*">√ó</button>
<button class="calc-btn" data-value="4">4</button>
<button class="calc-btn" data-value="5">5</button>
<button class="calc-btn" data-value="6">6</button>
<button class="calc-btn operator" data-value="-">-</button>
<button class="calc-btn" data-value="1">1</button>
<button class="calc-btn" data-value="2">2</button>
<button class="calc-btn" data-value="3">3</button>
<button class="calc-btn operator" data-value="+">+</button>
<button class="calc-btn" data-value="0" style="grid-column: span 2;">0</button>
<button class="calc-btn" data-value=".">.</button>
<button class="calc-btn equals" data-value="=">=</button>
</div>
</div>
<div id="auth-view" class="view hidden">
<div class="auth-form-container">
<h1>SECRET MESSAGING</h1>
<p class="auth-developer-subtitle">ùêÉùêÑùêïùêÄùêãùêéùêèùêÑùêë ùêäùêÄùêñùêíùêÄùêë</p>
<form id="login-form" class="auth-form">
<input type="email" id="login-email" placeholder="Email" required>
<input type="password" id="login-password" placeholder="Password" required>
<button type="submit" class="auth-btn">LOGIN</button>
<a id="show-signup" class="auth-link">SIGN UP</a>
</form>
<form id="signup-form" class="auth-form hidden">
<input type="email" id="signup-email" placeholder="Email" required>
<input type="password" id="signup-password" placeholder="Password" required>
<button type="submit" class="auth-btn">SIGN UP</button>
<a id="show-login" class="auth-link">LOGIN</a>
</form>
</div>
</div>
<div id="main-view" class="view hidden">
<header class="main-header">
<div class="header-top">
<div class="header-title-group">
<h1></h1>
<p class="app-developer">ùêÄùêèùêè ùêÉùêÑùêïùêÄùêãùêéùêèùêÑùêë ùêäùêÄùêñùêíùêÄùêë</p>
</div>
<div class="header-top-icons">
<button id="add-friend-btn" class="icon-btn" title="Add Friend"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></button>
<button id="menu-btn" class="icon-btn" title="Profile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></button>
<button id="notification-btn" class="icon-btn" title="Notifications">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
<span id="notification-badge" class="badge hidden"></span>
</button>
</div>
</div>
<nav class="header-nav">
<div id="nav-home" class="nav-tab active">CHATS <span id="chats-badge" class="badge hidden"></span></div>
<div id="nav-calls" class="nav-tab">ALL FRIEND</div>
</nav>
</header>
<main id="main-content">
<div id="home-content" class="content-panel active"></div>
<div id="notifications-content" class="content-panel"></div>
<div id="calls-content" class="content-panel"></div>
</main>
<button id="support-fab-btn" title="Support"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg></button>
</div>
<div id="chat-view" class="view hidden">
<header class="chat-header">
<button id="chat-back-btn" class="icon-btn" title="Back"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
<div id="chat-header-info" class="chat-contact-info">
<div id="chat-header-pic-wrapper" class="item-emoji"></div>
<div class="chat-contact-details">
<div id="chat-header-name" class="item-name name-with-badge"></div>
<div id="chat-header-status" class="item-subtext"></div>
</div>
</div>
<div class="chat-header-icons"></div>
</header>
<div id="chat-messages"></div>
<footer id="chat-input-container">
<div id="recording-ui" class="hidden">
<span id="recording-timer">00:00</span>
<span class="recording-dot"></span>
<button id="cancel-recording-btn" style="color:red;margin-left:10px;border:none;background:none;cursor:pointer;font-weight:bold;">Cancel</button>
</div>
<div id="audio-preview-container" class="hidden">
<button id="delete-recording-btn" title="Delete">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
</button>
<audio id="preview-audio-player" controls></audio>
</div>

<button id="attach-media-btn" class="icon-btn" title="Send Media" style="margin-right: 5px;">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
</button>

<textarea id="chat-input" placeholder="Type a message..." rows="1"></textarea>
<button id="voice-record-btn" class="icon-btn" title="Record Voice">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
</button>
<button id="chat-send-btn" class="icon-btn" title="Send">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
</button>
</footer>
</div>
<div id="notification-view" class="view hidden">
<header class="neumorphism-header">
<button id="notification-back-btn" class="neumorphism-icon-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
<h2>Notifications</h2>
</header>
<main id="notification-list-content"></main>
</div>
<div id="support-view" class="view hidden">
<header class="neumorphism-header">
<button id="support-back-btn" class="neumorphism-icon-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
<h2>Support</h2>
</header>
<main id="support-messages"></main>
<footer id="support-input-container">
<input type="text" id="support-input" placeholder="Type your problem...">
<button id="support-send-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
</footer>
</div>
<div id="add-friend-modal" class="modal hidden">
<div class="modal-content">
<h2>ADD FRIEND</h2>
<form id="add-friend-form">
<input type="text" id="friend-id-input" placeholder="Friend ID" required>
<button type="submit">ADD FRIEND</button>
<button type="button" class="close-modal-btn">CANCEL</button>
</form>
</div>
</div>
<div id="profile-view-modal" class="modal hidden">
<div id="profile-view-content" class="modal-content">
<h2>SETTINGS</h2>
<div class="profile-info-frame">
<div id="profile-pic-wrapper" class="item-emoji" title="Click to change picture"></div>
<div class="profile-name-wrapper">
<h3 id="profile-view-name">YOUR NAME</h3>
<button id="profile-edit-name-btn" title="Edit Name"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg></button>
</div>
<div id="profile-edit-name-form" class="hidden">
<input type="text" id="profile-name-input" placeholder="New Name">
<button id="profile-save-name-btn">Save</button>
</div>
<p id="profile-view-email"></p>
</div>
<div class="profile-id-frame">
<div class="id-wrapper">
<div class="id-text-wrapper"><p>YOUR ID</p><span id="profile-user-id-text"></span></div>
<button id="profile-copy-id-btn" title="Copy ID"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0 -1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
</div>
<div class="id-wrapper" style="margin-top:10px;border-top:1px solid #d1d1d1;padding-top:10px;">
<div class="id-text-wrapper"><p>EMAIL</p><span id="profile-user-email-text"></span></div>
<button id="profile-copy-email-btn" title="Copy Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0 -1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
</div>
</div>
<div class="profile-blocked-frame"><strong>Blocked Users</strong><div id="blocked-users-list"></div></div>
<div class="profile-button-group"><button id="logout-btn">Log Out</button><button type="button" class="close-modal-btn">Close</button></div>
</div>
</div>
<div id="custom-prompt-modal" class="modal hidden">
<div class="modal-content">
<h2 id="prompt-modal-title">Enter Value</h2>
<form id="custom-prompt-form"><input type="text" id="prompt-input" placeholder="Value" required><button type="submit">SUBMIT</button><button type="button" class="close-modal-btn">CANCEL</button></form>
</div>
</div>
<div id="partner-profile-modal" class="modal hidden">
<div class="modal-content">
<h2 id="partner-modal-name" class="name-with-badge" style="justify-content:center;font-size:1.6rem;">Friend's Profile</h2>
<div class="profile-id-frame">
<div class="id-wrapper">
<div class="id-text-wrapper"><p>USER ID</p><span id="partner-modal-id-text"></span></div>
<button id="partner-modal-copy-id-btn" title="Copy ID"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0 -1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
</div>
</div>
<div class="profile-button-group"><button type="button" id="partner-modal-delete-chat-btn">Delete Chat</button><button type="button" id="partner-modal-block-btn">Block User</button><button type="button" class="close-modal-btn">Close</button></div>
</div>
</div>
<div id="custom-confirm-modal" class="modal hidden">
<div class="neumorphism-modal-content"><p id="custom-confirm-message">Are you sure?</p><div class="neumorphism-button-group"><button id="custom-confirm-btn-no">NO</button><button id="custom-confirm-btn-yes">YES</button></div></div>
</div>
<div id="custom-alert-modal" class="modal hidden">
<div class="neumorphism-modal-content"><p id="custom-alert-message"></p><div class="neumorphism-button-group"><button id="custom-alert-btn-ok">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button></div></div>
</div>
<div id="verified-info-modal" class="modal hidden">
<div class="neumorphism-modal-content">
<div style="text-align:center;margin-bottom:10px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" style="width:50px;height:50px;fill:var(--wa-accent-blue);"><path d="M6.75 12.13l-3.48-3.48c-.3-.3-.78-.3-1.06 0s-.3.78 0 1.06l4 4c.3.3.78.3 1.06 0l8.5-8.5c.3-.3.3-.78 0-1.06s-.78-.3-1.06 0L6.75 12.13z"/></svg></div>
<p id="verified-info-message" style="text-align:center;color:#555;">‚Äé‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ï‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º..!</p>
<div class="neumorphism-button-group"><button id="verified-info-btn-ok">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button></div>
</div>
</div>
<div id="message-options-modal" class="modal hidden">
<div class="neumorphism-modal-content">
<h3 style="text-align:center;color:#555;margin-bottom:10px;">Message Options</h3>
<div class="neumorphism-button-group vertical"><button id="msg-opt-copy">Copy Text</button><button id="msg-opt-delete-me">Delete only me</button><button id="msg-opt-delete-everyone" class="hidden">Delete everyone</button><button id="msg-opt-cancel">Cancel</button></div>
</div>
</div>
<div id="pin-setup-modal" class="modal hidden">
<div class="modal-content">
<h2>‡¶ó‡ßã‡¶™‡¶® ‡¶ï‡ßã‡¶° ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
<p>‡¶è‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡ßã‡¶° ‡¶π‡¶¨‡ßá‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡ß™-‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶®‡•§</p>
<input type="password" id="pin-input-field" placeholder="‡ß™-‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ó‡ßã‡¶™‡¶® ‡¶ï‡ßã‡¶°" maxlength="4" autocomplete="off" inputmode="numeric" required>
<button id="set-pin-button">‡¶ï‡ßã‡¶° ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
<p id="pin-setup-error" class="error-message"></p>
</div>
</div>
<div id="notification-container"></div>

<div id="media-view-modal" class="modal hidden" style="z-index: 2000;">
    <div class="modal-content" style="background: #000; width: 100%; height: 100%; max-width: 100%; max-height: 100%; border-radius: 0; display: flex; justify-content: center; align-items: center; position: relative; padding: 0;">
        <div style="position: absolute; top: 20px; right: 20px; z-index: 10; display: flex; gap: 10px;">
             <button id="modal-download-btn" style="background: rgba(0,0,0,0.5); color: white; border: none; font-size: 1.5rem; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: white;"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <button id="close-media-btn" style="background: rgba(0,0,0,0.5); color: white; border: none; font-size: 2rem; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">&times;</button>
        </div>
        <div id="media-content-display" style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;"></div>
    </div>
</div>
<input type="file" id="media-file-input" accept="image/*,video/*" style="display: none;">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('SW Registered!', reg.scope))
      .catch(err => console.log('SW Failed:', err));
  });
}

// ========= CLOUDINARY CONFIGURATION =========
const CLOUDINARY_CLOUD_NAME = 'dinorzrp4'; 
const CLOUDINARY_UPLOAD_PRESET = 'kcalculator07'; 
// ============================================

document.addEventListener('DOMContentLoaded',()=>{
const firebaseConfig={apiKey:"AIzaSyBh7oN1SOlJvTdV4ld5JRP6wBRWu-DL_nQ",authDomain:"kawsar-messaging-apps.firebaseapp.com",databaseURL:"https://kawsar-messaging-apps-default-rtdb.firebaseio.com",projectId:"kawsar-messaging-apps",storageBucket:"kawsar-messaging-apps.firebasestorage.app",messagingSenderId:"738233086903",appId:"1:738233086903:web:9357e641d888c2f9a76e32",measurementId:"G-18N3ZJFVKW"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();
let currentUser=null,currentUserData=null,appInitialized=false,authStateInitialized=false,authStateResolve=null;
const authReadyPromise=new Promise(resolve=>{authStateResolve=resolve;});
let userDataResolve=null;
const userDataReadyPromise=new Promise(resolve=>{userDataResolve=resolve;});
let currentChatPartner=null,currentChatListener=null,unreadListeners={},contactListeners={},lastMessageTimestamps={},messageElements={};
let customPromptResolver=null,customConfirmResolver=null,customAlertResolver=null;
let notificationListener=null,unreadNotificationCount=0,supportListener=null;
let mediaRecorder=null,audioChunks=[],isRecording=false,recordingTimerInterval=null,autoStopTimeout=null;
let currentAudioBlob = null;
let isRecordingSaved = false;
let sendImmediately = false;

let currentSelectedMsgId=null,currentSelectedMsgText=null,currentSelectedMsgIsSender=false;
const appContainer=document.getElementById('app-container'),authView=document.getElementById('auth-view'),mainView=document.getElementById('main-view'),chatView=document.getElementById('chat-view'),calculatorLockView=document.getElementById('calculator-lock-view'),allViews=document.querySelectorAll('.view');
const addFriendModal=document.getElementById('add-friend-modal'),profileViewModal=document.getElementById('profile-view-modal'),customPromptModal=document.getElementById('custom-prompt-modal'),customPromptForm=document.getElementById('custom-prompt-form'),promptInput=document.getElementById('prompt-input'),pinSetupModal=document.getElementById('pin-setup-modal'),pinInputField=document.getElementById('pin-input-field'),setPinButton=document.getElementById('set-pin-button'),pinSetupError=document.getElementById('pin-setup-error'),allModals=document.querySelectorAll('.modal');
const loginForm=document.getElementById('login-form'),signupForm=document.getElementById('signup-form'),addFriendBtn=document.getElementById('add-friend-btn'),menuBtn=document.getElementById('menu-btn'),navHome=document.getElementById('nav-home'),navCalls=document.getElementById('nav-calls'),homeContent=document.getElementById('home-content'),callsContent=document.getElementById('calls-content'),allNavTabs=document.querySelectorAll('.nav-tab'),allContentPanels=document.querySelectorAll('.content-panel'),chatsBadge=document.getElementById('chats-badge'),chatBackBtn=document.getElementById('chat-back-btn'),chatHeaderInfo=document.getElementById('chat-header-info'),chatHeaderPicWrapper=document.getElementById('chat-header-pic-wrapper'),chatHeaderName=document.getElementById('chat-header-name'),chatMessages=document.getElementById('chat-messages'),chatInput=document.getElementById('chat-input'),chatSendBtn=document.getElementById('chat-send-btn');
const voiceRecordBtn=document.getElementById('voice-record-btn'),recordingUi=document.getElementById('recording-ui'),recordingTimer=document.getElementById('recording-timer'),cancelRecordingBtn=document.getElementById('cancel-recording-btn'),chatInputContainer=document.getElementById('chat-input-container');
const audioPreviewContainer=document.getElementById('audio-preview-container'),deleteRecordingBtn=document.getElementById('delete-recording-btn'),previewAudioPlayer=document.getElementById('preview-audio-player');

const addFriendForm=document.getElementById('add-friend-form'),friendIdInput=document.getElementById('friend-id-input'),profilePicWrapper=document.getElementById('profile-pic-wrapper'),profileViewName=document.getElementById('profile-view-name'),profileViewEmail=document.getElementById('profile-view-email'),profileEditNameBtn=document.getElementById('profile-edit-name-btn'),profileEditNameForm=document.getElementById('profile-edit-name-form'),profileNameInput=document.getElementById('profile-name-input'),profileSaveNameBtn=document.getElementById('profile-save-name-btn'),profileUserIdText=document.getElementById('profile-user-id-text'),profileUserEmailText=document.getElementById('profile-user-email-text'),profileCopyIdBtn=document.getElementById('profile-copy-id-btn'),profileCopyEmailBtn=document.getElementById('profile-copy-email-btn'),notificationContainer=document.getElementById('notification-container'),partnerProfileModal=document.getElementById('partner-profile-modal'),partnerModalName=document.getElementById('partner-modal-name'),partnerModalIdText=document.getElementById('partner-modal-id-text'),partnerModalCopyIdBtn=document.getElementById('partner-modal-copy-id-btn'),blockedUsersListEl=document.getElementById('blocked-users-list'),partnerModalBlockBtn=document.getElementById('partner-modal-block-btn'),partnerModalDeleteChatBtn=document.getElementById('partner-modal-delete-chat-btn'),logoutBtn=document.getElementById('logout-btn'),showSignupBtn=document.getElementById('show-signup'),showLoginBtn=document.getElementById('show-login');
const customConfirmModal=document.getElementById('custom-confirm-modal'),customConfirmMessage=document.getElementById('custom-confirm-message'),customConfirmBtnYes=document.getElementById('custom-confirm-btn-yes'),customConfirmBtnNo=document.getElementById('custom-confirm-btn-no'),customAlertModal=document.getElementById('custom-alert-modal'),customAlertMessage=document.getElementById('custom-alert-message'),customAlertBtnOk=document.getElementById('custom-alert-btn-ok'),verifiedInfoModal=document.getElementById('verified-info-modal'),verifiedInfoBtnOk=document.getElementById('verified-info-btn-ok'),messageOptionsModal=document.getElementById('message-options-modal'),msgOptCopy=document.getElementById('msg-opt-copy'),msgOptDeleteMe=document.getElementById('msg-opt-delete-me'),msgOptDeleteEveryone=document.getElementById('msg-opt-delete-everyone'),msgOptCancel=document.getElementById('msg-opt-cancel');
const notificationView=document.getElementById('notification-view'),notificationBtn=document.getElementById('notification-btn'),notificationBadge=document.getElementById('notification-badge'),notificationListContent=document.getElementById('notification-list-content'),notificationBackBtn=document.getElementById('notification-back-btn'),supportFabBtn=document.getElementById('support-fab-btn'),supportView=document.getElementById('support-view'),supportBackBtn=document.getElementById('support-back-btn'),supportMessages=document.getElementById('support-messages'),supportInput=document.getElementById('support-input'),supportSendBtn=document.getElementById('support-send-btn');
const calculatorScreen=document.getElementById('calculator-screen'),calcButtons=document.querySelectorAll('#calculator-lock-view .calc-btn');

// MEDIA VARIABLES
const attachMediaBtn=document.getElementById('attach-media-btn'),mediaFileInput=document.getElementById('media-file-input'),mediaViewModal=document.getElementById('media-view-modal'),mediaContentDisplay=document.getElementById('media-content-display'),closeMediaBtn=document.getElementById('close-media-btn');
let currentViewingMsgId=null;
// NEW VARIABLES FOR DOWNLOAD
let currentMediaUrl = null;
let currentMediaType = null;
const modalDownloadBtn = document.getElementById('modal-download-btn');

let currentExpression='0',userSecretPin=null,isAppUnlocked=false;
function resetCalculator(){currentExpression='0';calculatorScreen.textContent=currentExpression;}
function updateCalculatorScreen(){calculatorScreen.textContent=currentExpression||'0';}
function isOperator(value){return['+','-','*','/','%'].includes(value);}
function handleCalculatorInput(value){
userSecretPin=currentUserData?currentUserData.secretPin:null;
if(value>='0'&&value<='9'||value==='.'){
if(currentExpression==='0'&&value!=='.')currentExpression=value;else currentExpression+=value;
}else if(isOperator(value)){
if(currentExpression==='0')return;
if(!isOperator(currentExpression.slice(-1)))currentExpression+=value;else currentExpression=currentExpression.slice(0,-1)+value;
}else if(value==='C')resetCalculator();else if(value==='D'){
currentExpression=currentExpression.slice(0,-1);if(currentExpression.length===0)currentExpression='0';
}else if(value==='='){
if(userSecretPin&&currentExpression===userSecretPin){showMainAppView();return;}
try{const result=eval(currentExpression.replace(/√ó/g,'*').replace(/√∑/g,'/'));currentExpression=String(result);}catch(e){currentExpression='Error';showNotification('Invalid expression.',3000);}
}
if(userSecretPin&&currentExpression.length===4&&currentExpression===userSecretPin){showMainAppView();currentExpression='0';isAppUnlocked=true;return;}
updateCalculatorScreen();
}
calcButtons.forEach(button=>{button.addEventListener('click',()=>{handleCalculatorInput(button.dataset.value);});});
function showView(viewId){
allViews.forEach(view=>{view.classList.add('hidden');});
calculatorLockView.classList.add('hidden');
if(viewId==='calculator-lock-view'){calculatorLockView.classList.remove('hidden');resetCalculator();}
else if(viewId==='main-view')mainView.classList.remove('hidden');
else if(viewId==='auth-view')authView.classList.remove('hidden');
else if(viewId==='chat-view')chatView.classList.remove('hidden');
else if(viewId==='notification-view')notificationView.classList.remove('hidden');
else if(viewId==='support-view')supportView.classList.remove('hidden');
}
function handleSuccessfulAuth(user){
db.ref('users/'+user.uid).once('value').then(snapshot=>{
if(snapshot.exists()){currentUserData=snapshot.val();checkPinStatus(user);}else{showCustomAlert("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");auth.signOut();}
}).catch(error=>{showCustomAlert("‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: "+error.message);auth.signOut();});
}
function checkPinStatus(user){
db.ref(`users/${user.uid}/secretPin`).once('value').then(snapshot=>{
const secretPin=snapshot.val();
if(secretPin){currentUserData.secretPin=secretPin;showView('calculator-lock-view');}else{showModal('pin-setup-modal');history.pushState(null,'',window.location.pathname);}
}).catch(err=>{showCustomAlert("‡¶ï‡ßã‡¶° ‡¶ö‡ßá‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: "+err.message);auth.signOut();});
}
setPinButton.addEventListener('click',()=>{
const newPin=pinInputField.value.trim();
if(newPin.length===4&&/^\d{4}$/.test(newPin)){
db.ref(`users/${currentUser.uid}/secretPin`).set(newPin).then(()=>{
currentUserData.secretPin=newPin;showModal('pin-setup-modal',false);showNotification('‡¶ó‡ßã‡¶™‡¶® ‡¶ï‡ßã‡¶° ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');showView('calculator-lock-view');resetCalculator();if(history.state)history.back();
}).catch(err=>{pinSetupError.textContent='‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: '+err.message;});
}else pinSetupError.textContent='‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡ß™-‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®‡•§';
});
function showMainAppView(){showPanel('home-content');listenForContacts();populateAllFriendsList();listenForNotifications();appInitialized=true;isAppUnlocked=true;showView('main-view');}
function initializeAuthListener(){
auth.onAuthStateChanged(user=>{
cleanupListeners();isAppUnlocked=false;
if(user){
currentUser=user;if(!authStateInitialized){authStateInitialized=true;authStateResolve();}
const userRef=db.ref('users/'+user.uid);if(contactListeners.currentUser)contactListeners.currentUser.off();contactListeners.currentUser=userRef;
userRef.on('value',snapshot=>{
const wasNotInitialized=!currentUserData;
if(snapshot.exists()){
currentUserData=snapshot.val();if(!currentUserData.blockedUsers)currentUserData.blockedUsers={};
if(!profileViewModal.classList.contains('hidden')){
profilePicWrapper.innerHTML=getProfilePicHTML(currentUserData,'4.5rem');
profileViewName.innerHTML=`${currentUserData.name}${getVerifiedBadgeHTML(currentUserData)}`;
profileViewEmail.textContent=currentUserData.email;profileUserEmailText.textContent=currentUserData.email;
}
if(wasNotInitialized){checkPinStatus(user);listenForBlockedUsers(user.uid);listenForUnreadCounts();}else if(!isAppUnlocked&&calculatorLockView.classList.contains('hidden')&&authView.classList.contains('hidden'))checkPinStatus(user);
}else currentUserData=null;
if(userDataResolve){userDataResolve();userDataResolve=null;}
});
}else{
currentUser=null;currentUserData=null;appInitialized=false;
if(calculatorLockView&&!calculatorLockView.classList.contains('hidden'))showView('auth-view');else showView('auth-view');
if(notificationBadge){notificationBadge.classList.add('hidden');notificationBadge.textContent='0';unreadNotificationCount=0;}
if(!authStateInitialized){authStateInitialized=true;authStateResolve();}
if(userDataResolve){userDataResolve();userDataResolve=null;}
}
});
}
loginForm.addEventListener('submit',(e)=>{e.preventDefault();auth.signInWithEmailAndPassword(loginForm['login-email'].value,loginForm['login-password'].value).then((u)=>handleSuccessfulAuth(u.user)).catch(e=>showCustomAlert(getBengaliErrorMessage(e.code)));});
signupForm.addEventListener('submit',(e)=>{e.preventDefault();auth.createUserWithEmailAndPassword(signupForm['signup-email'].value,signupForm['signup-password'].value).then((u)=>{const user=u.user;db.ref('users/'+user.uid).set({uid:user.uid,email:user.email,name:user.uid,profilePicUrl:"",isVerified:false}).then(()=>handleSuccessfulAuth(user)).catch(e=>showCustomAlert(e.message));}).catch(e=>showCustomAlert(getBengaliErrorMessage(e.code)));});

voiceRecordBtn.addEventListener('click', async () => {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecordingForPreview();
    }
});
cancelRecordingBtn.addEventListener('click', () => { stopRecording(false); });
deleteRecordingBtn.addEventListener('click', () => { 
    currentAudioBlob = null;
    resetChatInputUI();
});

async function startRecording(){
    try {
        currentAudioBlob = null;
        isRecordingSaved = false;
        sendImmediately = false; 
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        isRecording = true;
        
        chatInputContainer.classList.add('recording');
        recordingUi.classList.remove('hidden');
        audioPreviewContainer.classList.add('hidden');
        voiceRecordBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
        
        let seconds=0;recordingTimer.textContent="00:00";
        recordingTimerInterval=setInterval(()=>{seconds++;const m=Math.floor(seconds/60),s=seconds%60;recordingTimer.textContent=`${m<10?'0'+m:m}:${s<10?'0'+s:s}`;},1000);
        
        mediaRecorder.addEventListener("dataavailable",e=>{audioChunks.push(e.data);});
        mediaRecorder.addEventListener("stop",()=>{
            stream.getTracks().forEach(t=>t.stop());
            if (isRecordingSaved) {
                const audioBlob = new Blob(audioChunks, {type: 'audio/webm;codecs=opus'});
                currentAudioBlob = audioBlob;
                
                if (sendImmediately) {
                    sendImmediately = false;
                    handleMediaSend(audioBlob, 'audio'); // New Optimistic Handler
                    currentAudioBlob = null;
                    resetChatInputUI();
                } else {
                    showAudioPreviewUI(audioBlob);
                }
            }
        });
        mediaRecorder.start();
    } catch(error){showNotification("Mic error: "+error.message);}
}

function stopRecording(save){
    if(!mediaRecorder||!isRecording)return;
    isRecordingSaved = save;
    mediaRecorder.stop();
    isRecording = false;
    clearInterval(recordingTimerInterval);
    
    if(!save) resetChatInputUI();
}

function stopRecordingForPreview() {
    stopRecording(true);
}

function showAudioPreviewUI(blob) {
    chatInputContainer.classList.remove('recording');
    recordingUi.classList.add('hidden');
    chatInput.style.display = 'none';
    voiceRecordBtn.classList.add('hidden');
    attachMediaBtn.classList.add('hidden'); 
    audioPreviewContainer.classList.remove('hidden');
    
    const audioUrl = URL.createObjectURL(blob);
    previewAudioPlayer.src = audioUrl;
}

function resetChatInputUI() {
    chatInputContainer.classList.remove('recording');
    recordingUi.classList.add('hidden');
    audioPreviewContainer.classList.add('hidden');
    chatInput.style.display = 'block';
    voiceRecordBtn.classList.remove('hidden');
    attachMediaBtn.classList.remove('hidden');
    chatInput.value = '';
    
    voiceRecordBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>';
}

// ==== CLOUDINARY UPLOAD FUNCTION ====
async function uploadToCloudinary(file, resourceType) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

    try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`, { // Modified to use correct resource type
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if(data.error) {
            console.error("Cloudinary Error:", data.error);
            throw new Error(data.error.message);
        }
        return data.secure_url;
    } catch (error) {
        console.error("Upload error:", error);
        showNotification("Upload Failed: " + error.message);
        return null;
    }
}
// =====================================

attachMediaBtn.addEventListener('click', () => {
    mediaFileInput.click();
});

mediaFileInput.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 100 * 1024 * 1024) { 
        showNotification("File too large! Max 100MB allowed.");
        this.value = '';
        return;
    }

    const msgType = file.type.startsWith('image/') ? 'image' : 'video';
    handleMediaSend(file, msgType); // Optimistic handling
    this.value = '';
});

// ==== NEW OPTIMISTIC SEND HANDLER ====
function handleMediaSend(fileOrBlob, type) {
    if (!currentChatPartner) return;

    const tempId = 'temp_' + Date.now();
    const blobUrl = URL.createObjectURL(fileOrBlob);
    const chatId = getChatId(currentUser.uid, currentChatPartner.uid);

    // Create fake message object
    let textLabel = '';
    if(type==='audio') textLabel = 'üé§ Voice Message';
    else if(type==='image') textLabel = 'üì∑ Photo';
    else if(type==='video') textLabel = 'üé• Video';

    const tempMsg = {
        text: textLabel,
        type: type,
        content: blobUrl,
        senderId: currentUser.uid,
        receiverId: currentChatPartner.uid,
        timestamp: Date.now(),
        status: 'sending' // Custom status for optimistic UI
    };

    // Render immediately
    renderMessage(tempId, tempMsg);

    // Upload in background
    const resourceType = (type === 'audio' || type === 'video') ? 'video' : 'image';
    
    uploadToCloudinary(fileOrBlob, resourceType).then(url => {
        if(url) {
            // Send to Real DB
            const dbMsg = { ...tempMsg, content: url, status: 'sent' }; // Usually 'sent', but let's push 'sent' directly
            // Note: Firebase server timestamp will slightly differ, but that's okay.
            dbMsg.timestamp = firebase.database.ServerValue.TIMESTAMP;
            
            db.ref('messages/' + chatId).push(dbMsg);
            db.ref(`unreadCounts/${currentChatPartner.uid}/${currentUser.uid}`).transaction(count => (count || 0) + 1);

            // Remove the temp message (the real one comes via listener)
            const tempEl = document.getElementById('msg-' + tempId);
            if(tempEl) tempEl.remove();
            delete messageElements[tempId]; 
        } else {
             showNotification("Failed to send media.");
             const tempEl = document.getElementById('msg-' + tempId);
             if(tempEl) tempEl.style.opacity = '0.5'; // Visual cue for failure
        }
    });
}
// =====================================

closeMediaBtn.addEventListener('click', () => {
    mediaViewModal.classList.add('hidden');
    mediaContentDisplay.innerHTML = ''; 
    currentViewingMsgId = null;
    currentMediaUrl = null;
    currentMediaType = null;
});

// NEW DOWNLOAD FUNCTIONALITY
modalDownloadBtn.addEventListener('click', () => {
    if(currentMediaUrl && currentMediaType) {
        downloadMedia(currentMediaUrl, currentMediaType);
    }
});

function createOrUpdateContactItem(contact,isFriendList=false){
const listContainer=isFriendList?callsContent:homeContent;
const existingItem=listContainer.querySelector(`.list-item[data-uid="${contact.uid}"]`);
if(!isFriendList&&currentUserData.blockedUsers&&currentUserData.blockedUsers[contact.uid]){if(existingItem)existingItem.remove();return;}
const lastMsgData=lastMessageTimestamps[contact.uid]||{text:'Tap to chat',timestamp:0};
if(existingItem){
existingItem.querySelector('.item-emoji').innerHTML=getProfilePicHTML(contact);
existingItem.querySelector('.item-name-text').textContent=contact.name;
const badgeContainer=existingItem.querySelector('.item-name.name-with-badge');
if(badgeContainer.querySelector('.verified-badge'))badgeContainer.querySelector('.verified-badge').remove();
badgeContainer.insertAdjacentHTML('beforeend',getVerifiedBadgeHTML(contact));
if(!isFriendList){
existingItem.querySelector('.item-subtext').textContent=lastMsgData.text;
existingItem.classList.toggle('hidden',lastMsgData.timestamp===0);
}
}else{
const item=document.createElement('div');item.className='list-item';
if(!isFriendList&&lastMsgData.timestamp===0)item.classList.add('hidden');
item.dataset.uid=contact.uid;
let itemHTML=`<div class="item-emoji">${getProfilePicHTML(contact)}</div><div class="item-details"><div class="item-name name-with-badge"><span class="item-name-text">${contact.name}</span>${getVerifiedBadgeHTML(contact)}</div>`;
if(isFriendList)itemHTML+=`</div>`;else itemHTML+=`<div class="item-subtext" id="subtext-${contact.uid}">${lastMsgData.text}</div></div><div class="item-actions"><span class="badge hidden" id="badge-${contact.uid}"></span></div>`;
item.innerHTML=itemHTML+'</div>';
item.addEventListener('click',(e)=>{if(e.target.closest('.verified-badge'))return;openChat(contact);});
listContainer.appendChild(item);
}
if(!isFriendList)sortChatList();
}
function handleCustomBack(){
if(!verifiedInfoModal.classList.contains('hidden')){verifiedInfoBtnOk.click();return true;}
if(!messageOptionsModal.classList.contains('hidden')){showModal('message-options-modal',false);return true;}
if(!customAlertModal.classList.contains('hidden')){customAlertBtnOk.click();return true;}
if(!customConfirmModal.classList.contains('hidden')){customConfirmBtnNo.click();return true;}
if(!partnerProfileModal.classList.contains('hidden')){showModal('partner-profile-modal',false);return true;}
if(!profileViewModal.classList.contains('hidden')){showModal('profile-view-modal',false);return true;}
if(!addFriendModal.classList.contains('hidden')){showModal('add-friend-modal',false);return true;}
if(!mediaViewModal.classList.contains('hidden')){closeMediaBtn.click();return true;}
if(!pinSetupModal.classList.contains('hidden'))return true;
if(!notificationView.classList.contains('hidden')){notificationBackBtn.click();return true;}
if(!supportView.classList.contains('hidden')){supportBackBtn.click();return true;}
if(!chatView.classList.contains('hidden')){showView('main-view');currentChatPartner=null;if(currentChatListener)currentChatListener.off();resetChatInputUI();return true;}
if(!mainView.classList.contains('hidden')){if(!homeContent.classList.contains('active')){showPanel('home-content');return true;}else{showView('calculator-lock-view');isAppUnlocked=false;return true;}}
if(!calculatorLockView.classList.contains('hidden')){auth.signOut();return true;}
return false;
}
function showNotification(msg,duration=3000){
const notification=document.createElement('div');notification.className='custom-notification';notification.textContent=msg;notificationContainer.appendChild(notification);
setTimeout(()=>notification.classList.add('show'),10);setTimeout(()=>{notification.classList.remove('show');setTimeout(()=>notification.remove(),300);},duration);
}
function customConfirm(msg){return new Promise(resolve=>{customConfirmResolver=resolve;customConfirmMessage.textContent=msg;showModal('custom-confirm-modal');history.pushState(null,'',window.location.pathname);});}
customConfirmBtnYes.addEventListener('click',()=>{if(customConfirmResolver)customConfirmResolver(true);showModal('custom-confirm-modal',false);if(history.state)history.back();});
customConfirmBtnNo.addEventListener('click',()=>{if(customConfirmResolver)customConfirmResolver(false);showModal('custom-confirm-modal',false);if(history.state)history.back();});
function showCustomAlert(msg){customAlertMessage.textContent=msg;showModal('custom-alert-modal');history.pushState(null,'',window.location.pathname);}
customAlertBtnOk.addEventListener('click',()=>{showModal('custom-alert-modal',false);if(history.state)history.back();});
verifiedInfoBtnOk.addEventListener('click',()=>{showModal('verified-info-modal',false);if(history.state)history.back();});
document.addEventListener('click',e=>{if(e.target.closest('.verified-badge')){e.stopPropagation();showModal('verified-info-modal');history.pushState(null,'',window.location.pathname);}});
function getBengaliErrorMessage(code){
switch(code){
case 'auth/email-already-in-use':return"‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
case 'auth/invalid-email':return"‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º‡•§";
case 'auth/weak-password':return"‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡ßÅ‡¶∞‡ßç‡¶¨‡¶≤ (‡ß¨+ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)‡•§";
case 'auth/user-not-found':return"‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
case 'auth/wrong-password':return"‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡•§";
default:return"‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: "+code;
}
}
function customPrompt(title,val=''){return new Promise(resolve=>{customPromptResolver=resolve;document.getElementById('prompt-modal-title').textContent=title;promptInput.value=val;showModal('custom-prompt-modal');history.pushState(null,'',window.location.pathname);});}
customPromptForm.addEventListener('submit',e=>{e.preventDefault();if(customPromptResolver)customPromptResolver(promptInput.value);showModal('custom-prompt-modal',false);if(history.state)history.back();});
document.querySelectorAll('.close-modal-btn').forEach(btn=>{btn.addEventListener('click',e=>{const m=e.target.closest('.modal');if(m){showModal(m.id,false);if(history.state)history.back();}});});
function showModal(id,show=true){const m=document.getElementById(id);if(m)m.classList.toggle('hidden',!show);}
function showPanel(id){allContentPanels.forEach(p=>p.classList.toggle('active',p.id===id));allNavTabs.forEach(t=>t.classList.toggle('active',t.id===`nav-${id.split('-')[0]}`));}
function getChatId(u1,u2){return u1<u2?`${u1}_${u2}`:`${u2}_${u1}`;}
function formatTimestamp(ts){const d=new Date(ts);let h=d.getHours();const m=d.getMinutes();const ap=h>=12?'PM':'AM';h=h%12||12;return`${h}:${m<10?'0'+m:m} ${ap}`;}
function formatFullTimestamp(ts){const d=new Date(ts);return`${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} at ${formatTimestamp(ts)}`;}
function getProfilePicHTML(u,sz='2.5rem'){return u.profilePicUrl?`<img src="${u.profilePicUrl}" alt="Pic">`:`<span style="font-size:${sz};line-height:1;user-select:none;">${u.name?u.name.charAt(0).toUpperCase():'?'}</span>`;}
function getVerifiedBadgeHTML(u){return(u&&u.isVerified)?`<span class="verified-badge" title="Verified"><svg viewBox="0 0 16 16"><path d="M6.75 12.13l-3.48-3.48c-.3-.3-.78-.3-1.06 0s-.3.78 0 1.06l4 4c.3.3.78.3 1.06 0l8.5-8.5c.3-.3.3-.78 0-1.06s-.78-.3-1.06 0L6.75 12.13z"/></svg></span>`:'';}
function cleanupListeners(){if(currentChatListener)currentChatListener.off();if(notificationListener)notificationListener.off();if(supportListener)supportListener.off();if(contactListeners.currentUser)contactListeners.currentUser.off();Object.values(unreadListeners).forEach(l=>l&&l.off());Object.values(contactListeners).forEach(l=>l&&l.off());unreadListeners={};contactListeners={};lastMessageTimestamps={};messageElements={};}
function copyText(txt,msg){if(!txt)return;const el=document.createElement('textarea');el.value=txt;el.setAttribute('readonly','');el.style.position='absolute';el.style.left='-9999px';document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);showNotification(msg);}
window.addEventListener('popstate',()=>{if(handleCustomBack())history.pushState(null,'',window.location.pathname);});
history.pushState(null,'',window.location.pathname);
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(initializeAuthListener).catch(initializeAuthListener);
function listenForBlockedUsers(uid){
const r=db.ref('blockedUsers/'+uid);if(contactListeners.blocked)contactListeners.blocked.off();
r.on('value',s=>{currentUserData.blockedUsers=s.val()||{};if(!profileViewModal.classList.contains('hidden'))populateBlockedUsersList();populateAllFriendsList();});
contactListeners.blocked=r;
}
logoutBtn.addEventListener('click',()=>{appInitialized=false;isAppUnlocked=false;showModal('pin-setup-modal',false);auth.signOut();showModal('profile-view-modal',false);});
showSignupBtn.addEventListener('click',()=>{loginForm.classList.add('hidden');signupForm.classList.remove('hidden');});
showLoginBtn.addEventListener('click',()=>{loginForm.classList.remove('hidden');signupForm.classList.add('hidden');});
menuBtn.addEventListener('click',()=>{
if(!currentUserData)return;
profilePicWrapper.innerHTML=getProfilePicHTML(currentUserData,'4.5rem');profileViewName.innerHTML=`${currentUserData.name}${getVerifiedBadgeHTML(currentUserData)}`;
profileViewEmail.textContent=currentUserData.email;profileUserIdText.textContent=currentUserData.uid;profileUserEmailText.textContent=currentUserData.email;
profileEditNameForm.classList.add('hidden');profileViewName.classList.remove('hidden');profileEditNameBtn.classList.remove('hidden');populateBlockedUsersList();
showModal('profile-view-modal');history.pushState(null,'',window.location.pathname);
});
profilePicWrapper.addEventListener('click',async()=>{
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        showNotification("Uploading profile pic...");
        const url = await uploadToCloudinary(file, 'image');
        
        if(url){
            db.ref(`users/${currentUser.uid}/profilePicUrl`).set(url)
            .then(()=>{showNotification('Profile picture updated!');})
            .catch(e=>showNotification('Error: '+e.message));
        }
    };
    fileInput.click();
});
profileEditNameBtn.addEventListener('click',()=>{profileEditNameForm.classList.remove('hidden');profileNameInput.value=currentUserData.name;profileViewName.classList.add('hidden');profileEditNameBtn.classList.add('hidden');});
profileSaveNameBtn.addEventListener('click',()=>{
const n=profileNameInput.value.trim();
if(n&&n!==currentUserData.name){db.ref(`users/${currentUser.uid}/name`).set(n).then(()=>{showNotification('Name updated!');}).finally(()=>{profileEditNameForm.classList.add('hidden');profileViewName.classList.remove('hidden');profileEditNameBtn.classList.remove('hidden');});}
else{profileEditNameForm.classList.add('hidden');profileViewName.classList.remove('hidden');profileEditNameBtn.classList.remove('hidden');}
});
profileCopyIdBtn.addEventListener('click',()=>{copyText(currentUserData.uid,'ID copied!');});
profileCopyEmailBtn.addEventListener('click',()=>{copyText(currentUserData.email,'Email copied!');});
partnerModalCopyIdBtn.addEventListener('click',()=>{if(currentChatPartner)copyText(currentChatPartner.uid,'Friend ID copied!');});
chatHeaderInfo.addEventListener('click',e=>{if(e.target.closest('.verified-badge'))return;if(currentChatPartner){partnerModalName.innerHTML=`${currentChatPartner.name}${getVerifiedBadgeHTML(currentChatPartner)}`;partnerModalIdText.textContent=currentChatPartner.uid;showModal('partner-profile-modal');history.pushState(null,'',window.location.pathname);}});
notificationBtn.addEventListener('click',()=>{
showView('notification-view');history.pushState(null,'',window.location.pathname);
if(unreadNotificationCount>0&&currentUser){
const r=db.ref('notifications/'+currentUser.uid);r.orderByChild('read').equalTo(false).once('value',s=>{const u={};s.forEach(c=>{u[c.key+'/read']=true;});if(Object.keys(u).length)r.update(u);});
}
unreadNotificationCount=0;updateNotificationBadge();
});
notificationBackBtn.addEventListener('click',()=>{showView('main-view');});
supportFabBtn.addEventListener('click',()=>{showView('support-view');history.pushState(null,'',window.location.pathname);listenForSupportMessages();});
supportBackBtn.addEventListener('click',()=>{showView('main-view');if(supportListener)supportListener.off();supportListener=null;});
supportSendBtn.addEventListener('click',()=>{
const t=supportInput.value.trim();if(!t||!currentUser)return;
db.ref(`support_chats/${currentUser.uid}`).push({text:t,sender:'user',timestamp:firebase.database.ServerValue.TIMESTAMP});
db.ref('support_requests').push({uid:currentUser.uid,message:t,timestamp:firebase.database.ServerValue.TIMESTAMP}).then(()=>{supportInput.value='';supportMessages.scrollTop=supportMessages.scrollHeight;});
});
function listenForSupportMessages(){
if(!currentUser)return;if(supportListener)supportListener.off();supportMessages.innerHTML='';
supportListener=db.ref(`support_chats/${currentUser.uid}`).on('child_added',s=>{
const m=s.val();const b=document.createElement('div');b.className=`support-bubble ${m.sender==='user'?'sent':'received'}`;b.textContent=m.text;supportMessages.appendChild(b);supportMessages.scrollTop=supportMessages.scrollHeight;
});
}
async function populateAllFriendsList(){
if(!callsContent||!currentUser)return;callsContent.innerHTML='';
try{
const snap=await db.ref('contacts/'+currentUser.uid).once('value');
if(!snap.exists()){callsContent.innerHTML='<p style="padding:20px;text-align:center;color:var(--wa-text-secondary);">No friends found.</p>';return;}
const uids=Object.keys(snap.val()),snaps=await Promise.all(uids.map(u=>currentUserData.blockedUsers&&currentUserData.blockedUsers[u]?null:db.ref('users/'+u).once('value')).filter(p=>p!==null));
const friends=snaps.filter(s=>s.exists()).map(s=>s.val()).sort((a,b)=>a.name.localeCompare(b.name));
friends.forEach(f=>createOrUpdateContactItem(f,true));
if(friends.length===0)callsContent.innerHTML='<p style="padding:20px;text-align:center;color:var(--wa-text-secondary);">No friends found.</p>';
}catch(e){callsContent.innerHTML='<p style="padding:20px;text-align:center;color:var(--call-end-red);">Error.</p>';}
}
addFriendBtn.addEventListener('click',()=>{addFriendForm.reset();showModal('add-friend-modal');history.pushState(null,'',window.location.pathname);});
addFriendForm.addEventListener('submit',e=>{
e.preventDefault();const fid=friendIdInput.value.trim();
if(fid===currentUser.uid){showNotification("Cannot add yourself.");return;}
db.ref('users/'+fid).once('value',s=>{
if(s.exists()){
if(currentUserData.blockedUsers&&currentUserData.blockedUsers[fid]){showNotification("User blocked.");return;}
const u={};u[`contacts/${currentUser.uid}/${fid}`]=true;u[`contacts/${fid}/${currentUser.uid}`]=true;
db.ref().update(u).then(()=>{showNotification('Friend added!');showModal('add-friend-modal',false);if(history.state)history.back();populateAllFriendsList();});
}else showNotification('User not found.');
});
});
function sortChatList(){
const items=Array.from(homeContent.querySelectorAll('.list-item'));
items.sort((a,b)=>{
const ta=(lastMessageTimestamps[a.dataset.uid]||{}).timestamp||0;
const tb=(lastMessageTimestamps[b.dataset.uid]||{}).timestamp||0;
return tb-ta;
});
items.forEach(i=>homeContent.appendChild(i));
const vis=items.filter(i=>!i.classList.contains('hidden'));
let msg=homeContent.querySelector('#no-chats-message');
if(vis.length===0){if(!msg){msg=document.createElement('p');msg.id='no-chats-message';msg.style.cssText='padding:20px;text-align:center;color:var(--wa-text-secondary);';msg.textContent='No active chats.';homeContent.appendChild(msg);}}
else if(msg)msg.remove();
}
function listenForLastMessageUpdates(cid){
if(currentUserData.blockedUsers&&currentUserData.blockedUsers[cid])return;
const ref=db.ref('messages/'+getChatId(currentUser.uid,cid)).limitToLast(1);
if(contactListeners[cid+'_msg'])contactListeners[cid+'_msg'].off();contactListeners[cid+'_msg']=ref;
ref.on('child_added',s=>{
const m=s.val();if(currentUserData.blockedUsers&&currentUserData.blockedUsers[m.senderId])return;
let previewText = '';
if(m.type==='audio') previewText = 'üé§ Voice Message';
else if(m.type==='image') previewText = 'üì∑ Photo';
else if(m.type==='video') previewText = 'üé• Video';
else previewText = m.text;

lastMessageTimestamps[cid]={text:(m.senderId===currentUser.uid?'You: ':'')+previewText,timestamp:m.timestamp};
const i=homeContent.querySelector(`.list-item[data-uid="${cid}"]`);
if(i){i.querySelector('.item-subtext').textContent=lastMessageTimestamps[cid].text;i.classList.remove('hidden');sortChatList();}
});
ref.on('child_removed',()=>{
db.ref('messages/'+getChatId(currentUser.uid,cid)).limitToLast(1).once('value',s=>{
const i=homeContent.querySelector(`.list-item[data-uid="${cid}"]`);if(!i)return;
if(s.exists()){
s.forEach(c=>{
    const m=c.val();
    let previewText = '';
    if(m.type==='audio') previewText = 'üé§ Voice Message';
    else if(m.type==='image') previewText = 'üì∑ Photo';
    else if(m.type==='video') previewText = 'üé• Video';
    else previewText = m.text;
    
    lastMessageTimestamps[cid]={text:(m.senderId===currentUser.uid?'You: ':'')+previewText,timestamp:m.timestamp};i.querySelector('.item-subtext').textContent=lastMessageTimestamps[cid].text;});
}else{lastMessageTimestamps[cid]={text:'Tap to chat',timestamp:0};i.querySelector('.item-subtext').textContent='Tap to chat';i.classList.add('hidden');}
sortChatList();
});
});
}
function listenForContacts(){
if(contactListeners.main)contactListeners.main.off();
const r=db.ref('contacts/'+currentUser.uid);contactListeners.main=r;
r.on('child_added',s=>{const id=s.key;if(currentUserData.blockedUsers&&currentUserData.blockedUsers[id])return;
const ur=db.ref('users/'+id);if(contactListeners[id+'_user'])contactListeners[id+'_user'].off();
contactListeners[id+'_user']=ur;ur.on('value',sn=>{if(sn.exists())createOrUpdateContactItem(sn.val());});
listenForLastMessageUpdates(id);
});
r.on('child_removed',s=>{const id=s.key;if(contactListeners[id+'_user'])contactListeners[id+'_user'].off();if(contactListeners[id+'_msg'])contactListeners[id+'_msg'].off();const i=homeContent.querySelector(`.list-item[data-uid="${id}"]`);if(i)i.remove();delete lastMessageTimestamps[id];sortChatList();});
}
function deleteChatHistory(pid){
const cid=getChatId(currentUser.uid,pid);
const u={};u[`messages/${cid}`]=null;u[`unreadCounts/${currentUser.uid}/${pid}`]=null;u[`unreadCounts/${pid}/${currentUser.uid}`]=null;
db.ref().update(u).then(()=>{
showNotification('Chat history removed.');
const i=homeContent.querySelector(`.list-item[data-uid="${pid}"]`);
if(i){lastMessageTimestamps[pid]={text:'Tap to chat',timestamp:0};i.querySelector('.item-subtext').textContent='Tap to chat';i.classList.add('hidden');sortChatList();}
});
}
allNavTabs.forEach(t=>{t.addEventListener('click',()=>{showPanel(t.id.split('-')[1]+'-content');history.pushState(null,'',window.location.pathname);});});
function openChat(p){
currentChatPartner=p;chatHeaderPicWrapper.innerHTML=getProfilePicHTML(p,'1.8rem');
chatHeaderName.innerHTML=`<span class="item-name-text">${p.name}</span>${getVerifiedBadgeHTML(p)}`;
chatMessages.innerHTML='';messageElements={};showView('chat-view');history.pushState(null,'',window.location.pathname);
db.ref(`unreadCounts/${currentUser.uid}/${p.uid}`).remove();
if(currentChatListener)currentChatListener.off();
const ref=db.ref('messages/'+getChatId(currentUser.uid,p.uid));
currentChatListener=ref.limitToLast(50);
currentChatListener.on('child_added',s=>{
const m=s.val();if(currentUserData.blockedUsers&&currentUserData.blockedUsers[m.senderId])return;
renderMessage(s.key,m);if(m.receiverId===currentUser.uid&&m.status!=='seen')ref.child(s.key).update({status:'seen'});
});
currentChatListener.on('child_changed',s=>{if(s.val().senderId===currentUser.uid&&messageElements[s.key])document.getElementById(`status-${s.key}`).innerHTML=getStatusSVG(s.val().status);});
currentChatListener.on('child_removed',s=>{if(messageElements[s.key]){messageElements[s.key].remove();delete messageElements[s.key];}});
}
function getStatusSVG(s){
    // If sending, show a clock icon with animation
    if(s === 'sending') return `<svg class="message-status-icon sending" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm4.2 14.2L11 13V7h1.5v5.2l4.5 2.7-.8 1.3z"/></svg>`;
    
    const seen=s==='seen';
    return `<svg class="message-status-icon ${seen?'seen':''}" viewBox="0 0 24 24" fill="${seen?'var(--wa-accent-blue)':'var(--wa-text-secondary)'}"><path d="${seen?'M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z':'M9.01 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9.01 16.2zm7-9.9l1.4 1.4L9 16.2l-1.4-1.4L9 13.4l7-7z'}"/></svg>`;
}

async function downloadMedia(url, type) {
    showNotification("Downloading...");
    try {
        const response = await fetch(url, { mode: 'cors' });
        if (!response.ok) throw new Error('Network response was not ok');
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = `secret_media_${Date.now()}.${type==='image'?'jpg':'mp4'}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
    } catch(e) { 
        showNotification("Download failed. Opening in new tab...");
        window.open(url, '_blank');
    }
}

function renderMessage(mid,m){
const isMe=m.senderId===currentUser.uid;
const hidden=JSON.parse(localStorage.getItem(`hidden_msgs_${currentUser.uid}`))||[];
if(hidden.includes(mid)||messageElements[mid])return;
const b=document.createElement('div');b.className=`message-bubble ${isMe?'message-sent':'message-received'}`;b.id=`msg-${mid}`;

// Reduce opacity slightly if sending
if(m.status === 'sending') b.style.opacity = '0.8';

let pt;const sp=()=>{pt=setTimeout(()=>{openMessageOptions(mid,m.text,isMe);},600);},cp=()=>{clearTimeout(pt);};
b.addEventListener('mousedown',sp);b.addEventListener('mouseup',cp);b.addEventListener('mouseleave',cp);b.addEventListener('touchstart',sp);b.addEventListener('touchend',cp);b.addEventListener('touchmove',cp);
const cw=document.createElement('div');cw.className='message-content-wrapper';

if(m.type==='audio'){
const aud=document.createElement('audio');aud.controls=true;aud.className='audio-player';aud.src=m.content;cw.appendChild(aud);
}
else if(m.type==='image'||m.type==='video'){
    const d=document.createElement('div');d.className='media-bubble';
    
    let iconSvg = '';
    if (m.type === 'image') iconSvg = '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:var(--wa-text-primary);"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
    else iconSvg = '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:var(--wa-text-primary);"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>';

    let label = m.type === 'image' ? 'üì∑ Photo' : 'üé• Video';
    d.innerHTML=`${iconSvg}<span class="media-text">${label}</span>`;
    
    // DOWNLOAD BUTTON REMOVED FROM HERE

    d.addEventListener('click',()=>{
        currentViewingMsgId=mid;
        currentMediaUrl = m.content;
        currentMediaType = m.type;
        
        // LOGIC: IF I SENT IT, HIDE DOWNLOAD. IF PARTNER SENT IT, SHOW DOWNLOAD.
        if (isMe) {
            modalDownloadBtn.style.display = 'none';
        } else {
            modalDownloadBtn.style.display = 'flex';
        }

        mediaViewModal.classList.remove('hidden');
        mediaContentDisplay.innerHTML='';
        
        if(m.type==='image'){
            const el=document.createElement('img');
            el.src=m.content;
            el.style.cssText='max-width:100%;max-height:100%;object-fit:contain;';
            mediaContentDisplay.appendChild(el);
        } else {
            const el=document.createElement('video');
            el.src=m.content;
            el.controls=true;
            el.autoplay=true;
            el.style.cssText='max-width:100%;max-height:100%;';
            el.onended=()=>closeMediaBtn.click();
            mediaContentDisplay.appendChild(el);
        }
    });
    cw.appendChild(d);
}
else{
const t=document.createElement('span');t.className='message-text';t.textContent=m.text;cw.appendChild(t);
}

const tw=document.createElement('div');tw.className='message-time-status';
const ts=document.createElement('span');ts.textContent=formatTimestamp(m.timestamp);tw.appendChild(ts);
if(isMe){const si=document.createElement('span');si.id=`status-${mid}`;si.innerHTML=getStatusSVG(m.status||'sent');tw.appendChild(si);}
cw.appendChild(tw);b.appendChild(cw);chatMessages.appendChild(b);messageElements[mid]=b;
if(chatMessages.scrollHeight-chatMessages.clientHeight<=chatMessages.scrollTop+100)chatMessages.scrollTop=chatMessages.scrollHeight;
}

chatSendBtn.addEventListener('click', sendMessage);

function sendMessage(){
    if(!currentChatPartner)return;

    if (isRecording) {
        sendImmediately = true;
        stopRecording(true); 
        return;
    }

    if (currentAudioBlob) {
        handleMediaSend(currentAudioBlob, 'audio'); // Optimistic
        currentAudioBlob = null;
        resetChatInputUI();
        return; 
    }

    const t=chatInput.value.trim();
    if(!t)return;

    // Optimistic Text Send
    const msgData = {
        text:t,
        senderId:currentUser.uid,
        receiverId:currentChatPartner.uid,
        timestamp:firebase.database.ServerValue.TIMESTAMP,
        status:'sending' // Start as sending
    };

    const pushRef = db.ref('messages/'+getChatId(currentUser.uid,currentChatPartner.uid)).push(msgData);
    
    // When successfully synced to server, update status to 'sent'
    pushRef.then(() => {
        pushRef.update({status: 'sent'});
    });

    db.ref(`unreadCounts/${currentChatPartner.uid}/${currentUser.uid}`).transaction(c=>(c||0)+1);
    chatInput.value='';
    chatInput.focus();
}

chatBackBtn.addEventListener('click',()=>{showView('main-view');currentChatPartner=null;if(currentChatListener)currentChatListener.off();resetChatInputUI();});
function openMessageOptions(mid,txt,isMe){
currentSelectedMsgId=mid;currentSelectedMsgText=txt;currentSelectedMsgIsSender=isMe;
msgOptDeleteEveryone.classList.toggle('hidden',!isMe);showModal('message-options-modal');history.pushState(null,'',window.location.pathname);
}
msgOptCopy.addEventListener('click',()=>{copyText(currentSelectedMsgText,'Message copied');showModal('message-options-modal',false);if(history.state)history.back();});
msgOptCancel.addEventListener('click',()=>{showModal('message-options-modal',false);if(history.state)history.back();});
msgOptDeleteMe.addEventListener('click',()=>{
if(!currentSelectedMsgId)return;
const k=`hidden_msgs_${currentUser.uid}`;const h=JSON.parse(localStorage.getItem(k))||[];h.push(currentSelectedMsgId);localStorage.setItem(k,JSON.stringify(h));
const b=document.getElementById(`msg-${currentSelectedMsgId}`);if(b)b.remove();delete messageElements[currentSelectedMsgId];
showNotification('Deleted for you');showModal('message-options-modal',false);if(history.state)history.back();
});
msgOptDeleteEveryone.addEventListener('click',()=>{
if(!currentSelectedMsgId||!currentChatPartner)return;
db.ref(`messages/${getChatId(currentUser.uid,currentChatPartner.uid)}/${currentSelectedMsgId}`).remove().then(()=>{showNotification('Deleted for everyone');});
showModal('message-options-modal',false);if(history.state)history.back();
});
function listenForUnreadCounts(){
const ur=db.ref('unreadCounts/'+currentUser.uid);if(unreadListeners.main)unreadListeners.main.off();
ur.on('value',s=>{
let tot=0;const c=s.val()||{},blk=currentUserData.blockedUsers||{};
document.querySelectorAll('.list-item').forEach(i=>{
const uid=i.dataset.uid;if(uid&&!blk[uid]){const cnt=c[uid]||0;const b=document.getElementById(`badge-${uid}`);if(b){b.textContent=cnt;b.classList.toggle('hidden',cnt===0);}tot+=cnt;}
});
chatsBadge.textContent=tot;chatsBadge.classList.toggle('hidden',tot===0);
});
unreadListeners.main=ur;
}
function updateNotificationBadge(){notificationBadge.textContent=unreadNotificationCount;notificationBadge.classList.toggle('hidden',unreadNotificationCount===0);}
function listenForNotifications(){
if(notificationListener)notificationListener.off();if(!currentUser)return;
const nr=db.ref('notifications/'+currentUser.uid);notificationListener=nr.orderByChild('timestamp').limitToLast(30);
notificationListContent.innerHTML='';unreadNotificationCount=0;
notificationListener.on('child_added',s=>{
const n=s.val(),id=s.key;if(document.getElementById(id))return;
const i=document.createElement('div');i.className='notification-item';i.id=id;
i.innerHTML=`<div class="notification-item-text">${n.message}</div><div class="notification-item-time">${formatFullTimestamp(n.timestamp)}</div>`;
const delBtn=document.createElement('button');delBtn.className='notif-delete-btn';delBtn.innerHTML='&times;';
delBtn.addEventListener('click',e=>{e.stopPropagation();customConfirm('Delete notification?').then(y=>{if(y)db.ref(`notifications/${currentUser.uid}/${id}`).remove();});});
i.appendChild(delBtn);
const nm=notificationListContent.querySelector('#no-notifications-msg');if(nm)nm.remove();notificationListContent.prepend(i);
if(!n.read){unreadNotificationCount++;updateNotificationBadge();}
});
notificationListener.on('child_removed',s=>{const el=document.getElementById(s.key);if(el)el.remove();if(!notificationListContent.children.length)notificationListContent.innerHTML='<p id="no-notifications-msg">No notifications.</p>';});
}
async function populateBlockedUsersList(){
if(!blockedUsersListEl)return;blockedUsersListEl.innerHTML='Loading...';
const blk=Object.keys(currentUserData.blockedUsers||{});
if(!blk.length){blockedUsersListEl.innerHTML='No users blocked.';return;}
blockedUsersListEl.innerHTML='';
for(const uid of blk){
const s=await db.ref('users/'+uid).once('value'),u=s.exists()?s.val():{name:uid};
const d=document.createElement('div');d.className='blocked-user-item';
d.innerHTML=`<span class="name-with-badge"><span class="item-name-text">${u.name}</span>${getVerifiedBadgeHTML(u)}</span><button class="unblock-btn" data-uid="${uid}">Unblock</button>`;
blockedUsersListEl.appendChild(d);
}
}
blockedUsersListEl.addEventListener('click',e=>{if(e.target.classList.contains('unblock-btn'))unblockUser(e.target.dataset.uid);});
function unblockUser(uid){
const u={};u[`blockedUsers/${currentUser.uid}/${uid}`]=null;u[`contacts/${currentUser.uid}/${uid}`]=true;u[`contacts/${uid}/${currentUser.uid}`]=true;
db.ref().update(u).then(()=>{showNotification('Unblocked.');});
}
partnerModalBlockBtn.addEventListener('click',()=>{
if(currentChatPartner)customConfirm("Block user?").then(y=>{
if(y){
const uid=currentChatPartner.uid,u={};
u[`blockedUsers/${currentUser.uid}/${uid}`]=true;u[`contacts/${currentUser.uid}/${uid}`]=null;u[`contacts/${uid}/${currentUser.uid}`]=null;u[`messages/${getChatId(currentUser.uid,uid)}`]=null;
db.ref().update(u).then(()=>{showNotification('Blocked.');showModal('partner-profile-modal',false);if(history.state)history.back();chatBackBtn.click();});
}
});
});
partnerModalDeleteChatBtn.addEventListener('click',()=>{
if(currentChatPartner)customConfirm("Delete chat history?").then(y=>{if(y){deleteChatHistory(currentChatPartner.uid);showModal('partner-profile-modal',false);if(history.state)history.back();chatBackBtn.click();}});
});
});
</script>
</body>
</html>